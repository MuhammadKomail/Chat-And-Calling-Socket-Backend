<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Simple Real-Time Chat</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4F46E5;
            --background-color: #F3F4F6;
            --container-bg: #FFFFFF;
            --text-color: #1F2937;
            --subtle-text: #6B7280;
            --border-color: #E5E7EB;
            --my-message-bg: #4F46E5;
            --other-message-bg: #E5E7EB;
            --font-family: 'Inter', sans-serif;
        }

        body {
            font-family: var(--font-family);
            background: var(--background-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
        }

        #loginBox,
        #registrationBox,
        #chatBox {
            width: 100%;
            background: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 32px;
            box-sizing: border-box;
        }

        #loginBox,
        #registrationBox {
            max-width: 420px;
            margin: 20px;
        }

        #chatBox {
            max-width: 800px;
            height: 80vh;
            padding: 0;
            display: none;
            flex-direction: column;
        }

        #registrationBox {
            display: none;
        }

        h2 {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            margin-top: 0;
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 14px;
            box-sizing: border-box;
            margin-bottom: 16px;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: var(--primary-color);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #4338CA;
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .form-footer {
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
        }

        .error-message {
            color: #EF4444;
            margin-top: 10px;
            font-size: 14px;
            text-align: center;
        }

        #chatContainer {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        #sidePanel {
            width: 250px;
            padding: 16px;
            overflow-y: auto;
            box-sizing: border-box;
        }

        #sidePanel h4 {
            margin-top: 0;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 600;
        }

        #userList {
            list-style: none;
            padding: 0;
        }

        #userList li {
            display: flex;
            justify-content: space-between;
            /* This will push the badge to the right */
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #userList li:hover {
            background-color: #F3F4F6;
        }

        #userList li.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            border-radius: 8px;
        }



        .unread-badge {
            background-color: #EF4444;
            /* Red color */
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        #userList li>span:first-child::before {
            content: '●';
            color: #22c55e;
            /* Green dot */
            margin-right: 8px;
            font-size: 14px;
            display: none;
            /* Hidden by default */
        }

        #userList li.active>span:first-child::before {
            display: inline-block;
            /* Show for active users */
        }

        #chatHeader {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .msg {
            margin-bottom: 12px;
        }

        .msg.me {
            text-align: right;
        }

        .msg .bubble {
            display: inline-block;
            padding: 10px 14px;
            border-radius: 18px;
            max-width: 80%;
            word-break: break-word;
            text-align: left;
        }

        .msg.me .bubble {
            background: var(--my-message-bg);
            color: white;
        }

        .msg:not(.me) .bubble {
            background: var(--other-message-bg);
            color: var(--text-color);
        }

        .msg .meta {
            font-size: 12px;
            color: var(--subtle-text);
            margin-top: 4px;
        }

        #msgForm {
            display: flex;
            padding: 16px;
            border-top: 1px solid var(--border-color);
            gap: 12px;
        }

        #msgInput {
            flex-grow: 1;
            margin-bottom: 0;
        }

        #sendBtn {
            width: auto;
            padding: 10px 20px;
            font-weight: 500;
        }

        #logoutBtn {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            background: #EF4444;
        }

        #logoutBtn:hover {
            background: #DC2626;
        }
    </style>
</head>

<body>
    <div id="loginBox">
        <h2>Login to Chat</h2>
        <label for="loginUserId">User ID:</label>
        <input type="number" id="loginUserId" placeholder="Enter your User ID" min="1">
        <button onclick="login()">Login</button>
        <div id="loginError" class="error-message"></div>
        <p class="form-footer">Don't have an account? <a href="#" onclick="showRegistrationForm()">Register</a></p>
    </div>

    <div id="registrationBox">
        <h2>Register</h2>
        <label for="regName">Name:</label>
        <input type="text" id="regName" placeholder="Enter your name">
        <label for="regEmail">Email:</label>
        <input type="email" id="regEmail" placeholder="Enter your email">
        <label for="regProfilePic">Profile Picture URL:</label>
        <input type="text" id="regProfilePic" placeholder="Enter image URL">
        <button onclick="registerUser()">Register</button>
        <div id="regMessage" class="error-message"></div>
        <p class="form-footer">Already have an account? <a href="#" onclick="showLoginForm()">Login</a></p>
    </div>

    <div id="chatBox">
        <div id="chatHeader">
            <div>
                <span id="chatHeaderText"></span>
                <span id="loggedInUserText"
                    style="font-size: 14px; color: var(--subtle-text); margin-left: 16px;"></span>
            </div>
            <button id="logoutBtn" onclick="logout()">Logout</button>
        </div>
        <div id="chatContainer">
            <div id="messages"></div>
            <div id="sidePanel">
                <div id="activeUsers">
                    <h4>All Users</h4>
                    <ul id="userList"></ul>
                </div>
            </div>
        </div>
        <form id="msgForm" onsubmit="sendMessage(event)">
            <input type="text" id="msgInput" placeholder="Type your message..." autocomplete="off" disabled>
            <button type="submit" id="sendBtn" disabled>Send</button>
        </form>
    </div>

    <script>
        let socket = null;
        let userId = null;
        let currentUserName = null;
        let roomId = null;
        let activeChatUserId = null;
        let isFetchingUsers = false; // Debounce flag
        const BASE = window.location.origin; // Use same origin as the page was served from

        function showRegistrationForm() {
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('registrationBox').style.display = 'block';
        }

        function showLoginForm() {
            document.getElementById('registrationBox').style.display = 'none';
            document.getElementById('loginBox').style.display = 'block';
        }

        async function registerUser() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const profilePic = document.getElementById('regProfilePic').value;
            const regMessage = document.getElementById('regMessage');

            if (!name || !email || !profilePic) {
                regMessage.innerText = 'Please fill in all fields.';
                return;
            }

            try {
                const res = await fetch(`${BASE}/api/user/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email, profilePic })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    const newUserId = data.message.data.id;
                    login(newUserId, 1); // Auto-login to Room 1
                } else {
                    regMessage.innerText = data.message.errorMessage || 'Registration failed.';
                }
            } catch (e) {
                regMessage.innerText = 'An error occurred during registration.';
                console.error("Error registering user:", e);
            }
        }

        async function fetchAndRenderActiveUsers() {
            if (isFetchingUsers) return; // Prevent concurrent executions
            isFetchingUsers = true;
            try {
                const res = await fetch(`${BASE}/api/user/activeUsers`);
                const data = await res.json();
                if (data.status === 'success' && data.message && Array.isArray(data.message.data)) {
                    const userList = document.getElementById('userList');
                    userList.innerHTML = ''; // Clear existing list

                    for (const activeUser of data.message.data) {
                        if (activeUser.userId !== userId) { // Exclude current user
                            const li = document.createElement('li');

                            // Fetch unread count
                            const unreadRes = await fetch(`${BASE}/api/room/unread-count`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ userId1: userId, userId2: activeUser.userId })
                            });
                            const unreadData = await unreadRes.json();
                            const unreadCount = unreadData.status === 'success' ? unreadData.message.data.unreadCount : 0;

                            li.innerHTML = `<span>${activeUser.User.name}</span>`;

                            if (unreadCount > 0) {
                                const badge = document.createElement('span');
                                badge.className = 'unread-badge';
                                badge.textContent = unreadCount;
                                li.appendChild(badge);
                            }

                            li.setAttribute('data-userid', activeUser.userId);

                            // Re-apply the active class if this user is the currently active one
                            if (activeUser.userId === activeChatUserId) {
                                li.classList.add('active');
                            }

                            li.onclick = (event) => {
                                const selectedUserId = activeUser.userId;
                                if (selectedUserId === activeChatUserId) {
                                    return; // Do nothing if the same chat is already selected
                                }
                                activeChatUserId = selectedUserId; // Update the active chat user

                                // Enable input and send button
                                document.getElementById('msgInput').disabled = false;
                                document.getElementById('sendBtn').disabled = false;
                                // Show msgForm when user selected
                                document.getElementById('msgForm').style.display = 'flex';

                                const userListItems = document.querySelectorAll('#userList li');
                                userListItems.forEach(item => item.classList.remove('active'));
                                event.currentTarget.classList.add('active');
                                document.getElementById('chatHeaderText').innerHTML = `Chat with <strong>${activeUser.User.name}</strong>`;
                                startPrivateChat(activeUser.userId);
                            };

                            // If no user is selected, disable input and send button
                            if (activeChatUserId === null) {
                                document.getElementById('msgInput').disabled = true;
                                document.getElementById('sendBtn').disabled = true;
                            }
                            userList.appendChild(li);
                        }
                    }
                } else {
                    console.error("Failed to fetch active users or unexpected format:", data);
                }
            } catch (e) {
                console.error("Error fetching active users:", e);
            } finally {
                isFetchingUsers = false; // Reset the flag
            }
        }

        function joinRoom(selectedRoomId) {
            if (!socket || !selectedRoomId) return;
            roomId = selectedRoomId;
            clearMessages(); // Clear previous messages before joining new room
            socket.emit('joinRoom', { roomId: roomId, joinUser: userId });
            fetchAndRenderMessages(roomId);
        }

        async function fetchAndRenderMessages(roomId) {
            try {
                const res = await fetch(`${BASE}/api/messages/` + roomId);
                const data = await res.json();
                if (data.status === 'success' && Array.isArray(data.message)) {
                    if (data.message.length === 0) {
                        addSystemMessage("No chat history. Start the conversation!", true);
                        // Show msgForm when user selected but no chat history
                        document.getElementById('msgForm').style.display = 'flex';
                    } else {
                        data.message.forEach(msg => {
                            addMessage({
                                message: msg.message,
                                name: msg.name || ('User ' + msg.userId),
                                userId: msg.userId,
                                createdAt: msg.createdAt
                            }, msg.userId == userId);
                        });
                    }
                } else {
                    console.log("API response structure unexpected:", data);
                }
            } catch (e) {
                console.error("Error fetching messages:", e);
            }
        }

        async function login(prefilledUserId) {
            userId = prefilledUserId || parseInt(document.getElementById('loginUserId').value);
            const loginError = document.getElementById('loginError');
            loginError.innerText = '';

            if (!userId) {
                loginError.innerText = 'Please enter a User ID.';
                return;
            }

            try {
                const res = await fetch(`${BASE}/api/user/exists/${userId}`);
                const data = await res.json();

                if (data.status !== 'success' || !data.message.exists) {
                    loginError.innerText = 'User ID does not exist. Please register or try a different ID.';
                    return;
                }

                const userRes = await fetch(`${BASE}/api/user/${userId}`);
                const userData = await userRes.json();
                if (userData.status === 'success') {
                    currentUserName = userData.message.data.name;
                } else {
                    currentUserName = `User ${userId}`;
                }
            } catch (e) {
                loginError.innerText = 'Error verifying User ID.';
                console.error('Error checking user existence:', e);
                return;
            }

            socket = io(BASE);
            socket.on('connect', () => {
                socket.emit('mapUser', userId);
                document.getElementById('loginBox').style.display = 'none';
                document.getElementById('registrationBox').style.display = 'none';
                document.getElementById('chatBox').style.display = 'flex';
                document.getElementById('loggedInUserText').innerHTML = `Logged in as: <strong>${currentUserName}</strong>`;
                document.getElementById('chatHeaderText').innerHTML = 'Select a user to chat with';
                clearMessages();
                addSystemMessage("Please select a chat to start messaging.", true);
                // Hide msgForm when no user is selected
                document.getElementById('msgForm').style.display = 'none';
                activeChatUserId = null; // Reset active chat on login
                // Disable input and send button on login
                document.getElementById('msgInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                fetchAndRenderActiveUsers();
            });
            socket.on('roomMessageDeliver', async (data) => {
                // If the message is for the currently active chat room
                if (data.roomId == roomId) {
                    addMessage(data, data.userId == userId);
                    // Mark the message as read since the user is actively viewing the chat
                    await fetch(`${BASE}/api/room/mark-as-read`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ roomId: roomId, userId: userId })
                    });
                    // Notify the sender that the message has been read
                    socket.emit('markAsRead', { roomId: roomId, userId: userId });
                } else {
                    // If the message is for a different chat, refresh the user list to update the unread count
                    fetchAndRenderActiveUsers();
                }
            });
            socket.on('userJoined', (data) => {
                // addSystemMessage(`${data.name || 'User ' + data.userId} joined the room.`);
                fetchAndRenderActiveUsers();
            });

            socket.on('userLeft', (data) => {
                addSystemMessage(`${data.name || 'User ' + data.userId} left the room.`);
                fetchAndRenderActiveUsers();
            });

            socket.on('messagesRead', (data) => {
                // A user has read messages in a room, update the UI if I am the sender
                const { roomId: readRoomId, readerId } = data;
                if (readerId !== userId) { // Ensure I am not the one who read the messages
                    fetchAndRenderActiveUsers(); // Re-fetch users to update unread counts
                }
            });

            socket.on('updateUnreadCount', (data) => {
                const { senderId, unreadCount } = data;
                // Find the user list item corresponding to the sender of the message
                const userListItem = document.querySelector(`#userList li[data-userid='${senderId}']`);

                if (userListItem) {
                    let badge = userListItem.querySelector('.unread-badge');

                    // If the count is zero, remove the badge if it exists
                    if (unreadCount === 0) {
                        if (badge) badge.remove();
                        return;
                    }

                    // If the badge doesn't exist, create it
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'unread-badge';
                        userListItem.appendChild(badge);
                    }

                    // Update the badge with the new count
                    badge.textContent = unreadCount;
                }
            });
        }

        function sendMessage(e) {
            e.preventDefault();
            const msg = document.getElementById('msgInput').value.trim();
            if (!msg || !socket || !roomId) return;
            socket.emit('roomMessage', {
                userId: userId,
                roomId: roomId,
                message: msg,
                name: currentUserName,
                isSaveInDb: true
            });
            addMessage({
                message: msg,
                name: currentUserName,
                userId: userId,
                createdAt: new Date().toISOString()
            }, true);
            document.getElementById('msgInput').value = '';
        }

        function addMessage(data, isMe) {
            const messages = document.getElementById('messages');
            const noHistoryMsg = messages.querySelector('.system-message');
            if (noHistoryMsg) {
                messages.innerHTML = ''; // Clear the 'no history' message
            }

            const div = document.createElement('div');
            div.className = 'msg' + (isMe ? ' me' : '');
            const time = data.createdAt ? new Date(data.createdAt).toLocaleTimeString() : new Date().toLocaleTimeString();
            div.innerHTML = `<div class="bubble">${data.message}</div><div class="meta">${time}</div>`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        function addSystemMessage(text, isCentered) {
            const messages = document.getElementById('messages');
            messages.innerHTML = ''; // Clear previous messages
            const div = document.createElement('div');
            div.className = 'msg system-message';
            if (isCentered) {
                div.style.textAlign = 'center';
                div.style.flexGrow = '1';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'center';
            }
            div.innerHTML = `<div class="bubble" style="background:#eee;color:#555;">${text}</div>`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        async function startPrivateChat(otherUserId) {
            try {
                const res = await fetch(`${BASE}/api/room/private`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId1: userId, userId2: otherUserId })
                });
                const data = await res.json();
                if (data.status === 'success' && data.message.roomId) {
                    const newRoomId = data.message.roomId;
                    joinRoom(newRoomId);

                    // Mark messages as read
                    await fetch(`${BASE}/api/room/mark-as-read`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ roomId: newRoomId, userId: userId })
                    });

                    // Emit event to notify other user
                    socket.emit('markAsRead', { roomId: newRoomId, userId: userId });

                    // Update UI immediately
                    const userListItem = document.querySelector(`#userList li[data-userid='${otherUserId}']`);
                    if (userListItem) {
                        const badge = userListItem.querySelector('.unread-badge');
                        if (badge) {
                            badge.remove();
                        }
                    }

                } else {
                    console.error("Failed to start private chat:", data);
                }
            } catch (e) {
                console.error("Error starting private chat:", e);
            }
        }

        function logout() {
            if (socket) {
                socket.emit('logout', userId);
                socket.disconnect();
            }
            document.getElementById('loginBox').style.display = 'block';
            document.getElementById('chatBox').style.display = 'none';
            document.getElementById('loginUserId').value = '';
            userId = null;
            roomId = null;
            activeChatUserId = null;
            clearMessages();
            // Disable input and send button on logout
            document.getElementById('msgInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
        }
    </script>
</body>

</html>